<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„Ø¹Ø¨Ø© Ø´Ø±Ø§Ø±Ø© Ø±ÙˆØ­</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background: #1a1a2e;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        .option-btn {
            transition: all 0.2s ease-in-out;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .option-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: #e94560;
        }
    </style>
</head>
<body class="text-gray-200 flex items-center justify-center min-h-screen p-4">

    <div id="app" class="container mx-auto max-w-2xl w-full">

        <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ -->
        <div id="setup-view" class="glass-card p-6 sm:p-8 rounded-2xl shadow-xl fade-in">
            <header class="text-center mb-6">
                <h1 class="text-4xl font-bold text-white">Ø´Ø±Ø§Ø±Ø© Ø±ÙˆØ­</h1>
                <p class="text-gray-400 mt-1">Ù„Ø¹Ø¨Ø© Ù…ÙˆØ§Ù‚Ù ÙˆØªÙØ§Ù‡Ù… Ø¨ÙŠÙ†ÙƒÙ…</p>
            </header>

            <div class="space-y-4 mb-6">
                <div>
                    <label for="player1-name-input" class="block mb-2 text-lg font-semibold text-gray-100">Ø§Ø³Ù… Ø§Ù„Ø´Ø§Ø¨</label>
                    <input type="text" id="player1-name-input" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ù‡Ù†Ø§" class="w-full p-3 border-2 bg-gray-800 border-gray-600 rounded-lg focus:border-pink-500 focus:ring-pink-500 transition text-white">
                </div>
                <div>
                    <label for="player2-name-input" class="block mb-2 text-lg font-semibold text-gray-100">Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Øª</label>
                    <input type="text" id="player2-name-input" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ù‡Ù†Ø§" class="w-full p-3 border-2 bg-gray-800 border-gray-600 rounded-lg focus:border-pink-500 focus:ring-pink-500 transition text-white">
                </div>
            </div>
            
            <div class="my-6 p-4 bg-gray-800 border border-gray-700 rounded-lg text-center">
                <p class="font-bold text-yellow-400">âš ï¸ ØªÙ†Ø¨ÙŠÙ‡ Ù‡Ø§Ù…</p>
                <p class="text-sm text-gray-300 mt-2">Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¯ÙŠ Ù…Ø¹Ù…ÙˆÙ„Ø© Ø¹Ø´Ø§Ù† ØªÙ‚Ø±Ø¨ÙƒÙˆØ§ Ù…Ù† Ø¨Ø¹Ø¶ ÙˆØªØ³ØªÙ…ØªØ¹ÙˆØ§. Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ù„ÙŠ Ø¨ØªØ·Ù„Ø¹ Ù‡ÙŠ Ù…Ø¬Ø±Ø¯ ØªÙØ³ÙŠØ±Ø§Øª Ø¥Ø¨Ø¯Ø§Ø¹ÙŠØ© Ù…Ù† Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ÙˆÙ…Ø´ ØªÙ‚ÙŠÙŠÙ… Ø¹Ù„Ù…ÙŠ.</p>
            </div>

            <button id="start-game-btn" class="w-full bg-pink-600 text-white font-black py-4 px-8 rounded-lg hover:bg-pink-700 transition shadow-lg text-2xl disabled:bg-gray-600 disabled:cursor-not-allowed" disabled>â¤ï¸ ÙŠÙ„Ø§ Ù†Ø´ÙˆÙ Ù‡Ù†ØªØµØ±Ù Ø¥Ø²Ø§ÙŠ</button>
        </div>

        <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ù„Ø¹Ø¨ (Ø§Ù„Ø£Ø³Ø¦Ù„Ø©) -->
        <div id="game-view" class="hidden glass-card p-6 sm:p-8 rounded-2xl shadow-xl fade-in">
            <div class="flex justify-between items-center mb-4 text-gray-400 font-bold">
                <div id="player-turn-name" class="text-2xl text-pink-400"></div>
                <div id="question-counter" class="text-lg"></div>
            </div>
            <div class="bg-gray-800 p-6 rounded-lg mb-6 min-h-[120px] flex items-center justify-center">
                <h2 id="question-text" class="text-2xl text-center font-semibold text-white"></h2>
            </div>
            <div id="options-container" class="grid grid-cols-1 gap-4">
                <!-- Options will be injected here -->
            </div>
        </div>
        
        <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© -->
        <div id="results-view" class="hidden">
            <header class="text-center mb-6 fade-in">
                <h1 class="text-4xl font-bold text-white">ØªØ­Ù„ÙŠÙ„ Ø¹Ù„Ø§Ù‚ØªÙƒÙ…</h1>
                <p class="text-gray-400 mt-1">Ø¯ÙŠ Ø±Ø¤ÙŠØ© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù„Ù‚ØµØªÙƒÙˆØ§</p>
            </header>
            <div id="results-container" class="glass-card p-6 rounded-2xl space-y-6">
                <!-- Relationship analysis will be injected here -->
            </div>
            
            <!-- AI Features Section -->
            <div id="ai-features" class="mt-8 glass-card p-6 rounded-2xl fade-in">
                 <h2 class="text-2xl font-bold text-center text-white mb-4">âœ¨ Ù„Ù…Ø³Ø© Ù…Ù† Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</h2>
                 <div class="space-y-4">
                    <button id="suggest-date-btn" class="w-full bg-purple-600 text-white font-bold py-3 px-5 rounded-lg hover:bg-purple-700 transition shadow">Ø§Ù‚ØªØ±Ø­ ÙÙƒØ±Ø© Ø®Ø±ÙˆØ¬Ø©</button>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <button id="compliment-p2-btn" class="w-full bg-teal-600 text-white font-bold py-3 px-5 rounded-lg hover:bg-teal-700 transition shadow"></button>
                        <button id="compliment-p1-btn" class="w-full bg-teal-600 text-white font-bold py-3 px-5 rounded-lg hover:bg-teal-700 transition shadow"></button>
                    </div>
                 </div>
            </div>

            <button id="play-again-btn" class="w-full mt-8 bg-pink-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-pink-700 transition">Ù†Ù„Ø¹Ø¨ ØªØ§Ù†ÙŠ</button>
        </div>

    </div>
    
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="hidden fixed inset-0 bg-black bg-opacity-80 flex flex-col items-center justify-center p-4 z-50">
        <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-24 w-24 mb-4 animate-spin"></div>
        <h2 id="loading-text" class="text-center text-white text-xl font-semibold"></h2>
    </div>

    <!-- AI Suggestion Modal -->
    <div id="ai-suggestion-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
        <div class="glass-card p-6 rounded-2xl shadow-xl max-w-lg w-full">
            <h3 id="ai-modal-title" class="text-2xl font-bold mb-4 text-center text-white"></h3>
            <div id="ai-modal-content" class="text-gray-300 text-lg leading-relaxed space-y-4 max-h-[60vh] overflow-y-auto p-2">
                <!-- AI content will be injected here -->
            </div>
            <div class="flex justify-center mt-6">
                <button id="close-ai-modal-btn" class="bg-gray-700 text-white font-bold py-2 px-8 rounded-lg hover:bg-gray-600">ØªÙ…Ø§Ù…</button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø© ---
            let gameState = {};
            let QUESTIONS = []; // Will be populated by AI

            // --- Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ---
            const views = { setup: document.getElementById('setup-view'), game: document.getElementById('game-view'), results: document.getElementById('results-view'), };
            const player1NameInput = document.getElementById('player1-name-input');
            const player2NameInput = document.getElementById('player2-name-input');
            const startGameBtn = document.getElementById('start-game-btn');
            const playerTurnName = document.getElementById('player-turn-name');
            const questionCounter = document.getElementById('question-counter');
            const questionText = document.getElementById('question-text');
            const optionsContainer = document.getElementById('options-container');
            const resultsContainer = document.getElementById('results-container');
            const playAgainBtn = document.getElementById('play-again-btn');
            const loadingOverlay = document.getElementById('loading-overlay');
            const loadingText = document.getElementById('loading-text');
            const suggestDateBtn = document.getElementById('suggest-date-btn');
            const complimentP1Btn = document.getElementById('compliment-p1-btn');
            const complimentP2Btn = document.getElementById('compliment-p2-btn');
            const aiSuggestionModal = document.getElementById('ai-suggestion-modal');
            const aiModalTitle = document.getElementById('ai-modal-title');
            const aiModalContent = document.getElementById('ai-modal-content');
            const closeAiModalBtn = document.getElementById('close-ai-modal-btn');

            function showView(viewName) {
                Object.values(views).forEach(view => view.classList.add('hidden'));
                views[viewName].classList.remove('hidden');
            }

            function init() {
                gameState = { players: [{}, {}], turnIndex: 0, relationshipAnalysis: '' };
                loadNamesFromStorage();
                showView('setup');
            }

            function validateSetup() {
                const name1 = player1NameInput.value.trim();
                const name2 = player2NameInput.value.trim();
                startGameBtn.disabled = !(name1 && name2);
            }
            
            function saveNamesToStorage() {
                localStorage.setItem('soulSparkPlayer1', gameState.players[0].name);
                localStorage.setItem('soulSparkPlayer2', gameState.players[1].name);
            }

            function loadNamesFromStorage() {
                const savedPlayer1 = localStorage.getItem('soulSparkPlayer1');
                const savedPlayer2 = localStorage.getItem('soulSparkPlayer2');
                if (savedPlayer1) {
                    player1NameInput.value = savedPlayer1;
                }
                if (savedPlayer2) {
                    player2NameInput.value = savedPlayer2;
                }
                validateSetup();
            }

            async function startGame() {
                const name1 = player1NameInput.value.trim();
                const name2 = player2NameInput.value.trim();
                if (!name1 || !name2) return;

                gameState.players[0] = { name: name1, answers: [] };
                gameState.players[1] = { name: name2, answers: [] };
                
                saveNamesToStorage();

                loadingText.textContent = "âœ¨ Ø¨Ù†Ø­Ø¶Ø± Ù…ÙˆØ§Ù‚Ù Ù…Ø®ØµÙˆØµØ© Ù„ÙŠÙƒÙˆØ§...";
                loadingOverlay.classList.remove('hidden');
                
                const success = await fetchAiQuestions();
                if (!success) {
                    alert("Ø­ØµÙ„ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ ØªØ­Ø¶ÙŠØ± Ø§Ù„Ù…ÙˆØ§Ù‚ÙØŒ Ù…Ù…ÙƒÙ† ØªØªØ£ÙƒØ¯ÙˆØ§ Ù…Ù† Ø§Ù„Ù†Øª ÙˆØªØ¬Ø±Ø¨ÙˆØ§ ØªØ§Ù†ÙŠ.");
                    loadingOverlay.classList.add('hidden');
                    return;
                }

                loadingOverlay.classList.add('hidden');
                gameState.turnIndex = 0;
                displayQuestion();
                showView('game');
            }
            
            async function fetchAiQuestions() {
                const player1Name = gameState.players[0].name;
                const player2Name = gameState.players[1].name;
                const prompt = `Ø£Ù†Øª Ù…ØµÙ…Ù… Ø£Ù„Ø¹Ø§Ø¨ Ù…ØªØ®ØµØµ ÙÙŠ Ø§Ù„Ø¹Ù„Ø§Ù‚Ø§Øª Ø§Ù„Ø¹Ø§Ø·ÙÙŠØ©. ØµÙ…Ù… Ù„Ø¹Ø¨Ø© Ø§Ø³Ù…Ù‡Ø§ "Ø´Ø±Ø§Ø±Ø© Ø±ÙˆØ­" Ø¨Ø§Ù„Ø¹Ø§Ù…ÙŠØ© Ø§Ù„Ù…ØµØ±ÙŠØ© Ù„Ø§ØªÙ†ÙŠÙ† Ù…Ø±ØªØ¨Ø·ÙŠÙ†ØŒ Ø§Ù„Ø´Ø§Ø¨ Ø§Ø³Ù…Ù‡ "${player1Name}" ÙˆØ§Ù„Ø¨Ù†Øª Ø§Ø³Ù…Ù‡Ø§ "${player2Name}".\n\nØ§Ø¹Ù…Ù„ 20 "Ù…ÙˆÙ‚Ù" Ø¬Ø¯ÙŠØ¯ ÙˆÙ…Ø®ØªÙ„Ù. Ù„ÙƒÙ„ Ù…ÙˆÙ‚ÙØŒ Ø§Ø¹Ù…Ù„ ØµÙŠØºØªÙŠÙ† Ù„Ù„Ø³Ø¤Ø§Ù„:\n1. ØµÙŠØºØ© Ù…ÙˆØ¬Ù‡Ø© Ù„Ù„Ø´Ø§Ø¨ (q_for_male) ÙˆÙÙŠÙ‡Ø§ Ø¨ØªØ³Ø£Ù„Ù‡ Ø¹Ù† Ø±Ø¯ ÙØ¹Ù„Ù‡ ØªØ¬Ø§Ù‡ Ø§Ù„Ø¨Ù†Øª. Ø§Ø³ØªØ®Ø¯Ù… Ø¹Ù„Ø§Ù…Ø© [Ø§Ù„Ø§Ø³Ù…] Ù…ÙƒØ§Ù† Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Øª.\n2. ØµÙŠØºØ© Ù…ÙˆØ¬Ù‡Ø© Ù„Ù„Ø¨Ù†Øª (q_for_female) ÙˆÙÙŠÙ‡Ø§ Ø¨ØªØ³Ø£Ù„Ù‡Ø§ Ø¹Ù† Ø±Ø¯ ÙØ¹Ù„Ù‡Ø§ ØªØ¬Ø§Ù‡ Ø§Ù„Ø´Ø§Ø¨. Ø§Ø³ØªØ®Ø¯Ù… Ø¹Ù„Ø§Ù…Ø© [Ø§Ù„Ø§Ø³Ù…] Ù…ÙƒØ§Ù† Ø§Ø³Ù… Ø§Ù„Ø´Ø§Ø¨.\n\nÙ…Ø«Ø§Ù„:\n- q_for_male: "Ù‡ØªØ¹Ù…Ù„ Ø¥ÙŠÙ‡ Ù„Ùˆ [Ø§Ù„Ø§Ø³Ù…] Ù‚Ø±Ø±Øª ÙØ¬Ø£Ø© ØªØºÙŠØ± Ù„ÙˆÙ† Ø´Ø¹Ø±Ù‡Ø§ Ù„Ù„ÙˆÙ† ØºØ±ÙŠØ¨ Ù…Ù† ØºÙŠØ± Ù…Ø§ ØªØ§Ø®Ø¯ Ø±Ø£ÙŠÙƒØŸ"\n- q_for_female: "Ù‡ØªØ¹Ù…Ù„ÙŠ Ø¥ÙŠÙ‡ Ù„Ùˆ [Ø§Ù„Ø§Ø³Ù…] Ù‚Ø±Ø± ÙØ¬Ø£Ø© ÙŠØºÙŠØ± Ù„ÙˆÙ† Ø´Ø¹Ø±Ù‡ Ù„Ù„ÙˆÙ† ØºØ±ÙŠØ¨ Ù…Ù† ØºÙŠØ± Ù…Ø§ ÙŠØ§Ø®Ø¯ Ø±Ø£ÙŠÙƒØŸ"\n\nÙƒÙ„ Ù…ÙˆÙ‚Ù Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† Ù„Ù‡ 4 Ø§Ø®ØªÙŠØ§Ø±Ø§Øª ÙƒØ±Ø¯ ÙØ¹Ù„ (o).\n\nØ·Ù„Ø¹ Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙÙŠ ØµÙŠØºØ© JSON Ù…Ø¸Ø¨ÙˆØ·Ø©: array ÙÙŠÙ‡Ø§ 20 objectØŒ ÙƒÙ„ object ÙÙŠÙ‡ key Ø§Ø³Ù…Ù‡ "q_for_male", "q_for_female", Ùˆ "o" (array ÙÙŠÙ‡Ø§ 4 Ø§Ø®ØªÙŠØ§Ø±Ø§Øª).`;
                const payload = {
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                    generationConfig: { responseMimeType: "application/json", responseSchema: { type: "OBJECT", properties: { questions: { type: "ARRAY", items: { type: "OBJECT", properties: { q_for_male: { type: "STRING" }, q_for_female: { type: "STRING" }, o: { type: "ARRAY", items: { type: "STRING" } } }, required: ["q_for_male", "q_for_female", "o"] } } }, required: ["questions"] } }
                };

                try {
                    const apiKey = ""; // Left empty
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) return false;
                    const result = await response.json();
                    const jsonText = result.candidates[0].content.parts[0].text;
                    const parsedJson = JSON.parse(jsonText);
                    if (parsedJson.questions && parsedJson.questions.length >= 20) {
                        QUESTIONS = parsedJson.questions;
                        return true;
                    }
                    return false;
                } catch (error) {
                    console.error("Error fetching AI questions:", error);
                    return false;
                }
            }

            function displayQuestion() {
                const questionIndex = Math.floor(gameState.turnIndex / 2);
                const questionTemplate = QUESTIONS[questionIndex];
                const currentPlayer = gameState.players[gameState.turnIndex % 2];
                const otherPlayer = gameState.players[(gameState.turnIndex + 1) % 2];
                
                const isMaleTurn = (gameState.turnIndex % 2) === 0;
                const questionTextTemplate = isMaleTurn ? questionTemplate.q_for_male : questionTemplate.q_for_female;
                const personalizedQuestion = questionTextTemplate.replace(/\[Ø§Ù„Ø§Ø³Ù…\]/g, otherPlayer.name);

                playerTurnName.textContent = `Ø¯ÙˆØ± ${currentPlayer.name}`;
                questionCounter.textContent = `Ø§Ù„Ù…ÙˆÙ‚Ù ${gameState.turnIndex + 1} / 20`;
                questionText.textContent = personalizedQuestion;

                optionsContainer.innerHTML = '';
                questionTemplate.o.forEach(option => {
                    const button = document.createElement('button');
                    button.textContent = option;
                    button.className = 'option-btn w-full text-lg font-semibold p-4 rounded-lg text-white';
                    button.onclick = () => handleAnswer(option);
                    optionsContainer.appendChild(button);
                });
            }

            function handleAnswer(selectedOption) {
                const currentPlayer = gameState.players[gameState.turnIndex % 2];
                const personalizedQuestionText = document.getElementById('question-text').textContent;
                
                currentPlayer.answers.push({ question: personalizedQuestionText, answer: selectedOption });
                moveToNext();
            }
            
            function moveToNext() {
                gameState.turnIndex++;
                if (gameState.turnIndex >= 20) {
                    analyzeRelationship();
                } else {
                    displayQuestion();
                }
            }

            async function analyzeRelationship() {
                loadingText.textContent = "Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø¨ÙŠØ­Ù„Ù„ Ø¹Ù„Ø§Ù‚ØªÙƒÙ…...";
                loadingOverlay.classList.remove('hidden');
                
                const player1 = gameState.players[0]; // Ø§Ù„Ø´Ø§Ø¨
                const player2 = gameState.players[1]; // Ø§Ù„Ø¨Ù†Øª

                const p1Answers = player1.answers.map(item => `Ø§Ù„Ù…ÙˆÙ‚Ù: ${item.question}\nØ±Ø¯ ÙØ¹Ù„Ù‡: ${item.answer}`).join('\n\n');
                const p2Answers = player2.answers.map(item => `Ø§Ù„Ù…ÙˆÙ‚Ù: ${item.question}\nØ±Ø¯ ÙØ¹Ù„Ù‡Ø§: ${item.answer}`).join('\n\n');

                const prompt = `Ø£Ù†Øª Ù…Ø³ØªØ´Ø§Ø± Ø¹Ù„Ø§Ù‚Ø§Øª Ø¹Ø§Ø·ÙÙŠØ© Ø®Ø¨ÙŠØ± ÙˆØ¨ØªØªÙƒÙ„Ù… Ø¨Ø§Ù„Ø¹Ø§Ù…ÙŠØ© Ø§Ù„Ù…ØµØ±ÙŠØ©. Ù‚Ø¯Ø§Ù…Ùƒ Ø±Ø¯ÙˆØ¯ Ø£ÙØ¹Ø§Ù„ Ø§ØªÙ†ÙŠÙ† Ù…Ø±ØªØ¨Ø·ÙŠÙ†ØŒ Ø§Ù„Ø´Ø§Ø¨ "${player1.name}" ÙˆØ§Ù„Ø¨Ù†Øª "${player2.name}"ØŒ Ø¹Ù„Ù‰ Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…ÙˆØ§Ù‚Ù.\n\nØ±Ø¯ÙˆØ¯ Ø£ÙØ¹Ø§Ù„ ${player1.name}:\n${p1Answers}\n\nØ±Ø¯ÙˆØ¯ Ø£ÙØ¹Ø§Ù„ ${player2.name}:\n${p2Answers}\n\nØ¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø±Ø¯ÙˆØ¯ Ø£ÙØ¹Ø§Ù„Ù‡Ù… Ø¯ÙŠØŒ Ø§ÙƒØªØ¨ ØªØ­Ù„ÙŠÙ„ Ø´Ø§Ù…Ù„ ÙˆÙ…ÙØµÙ„ Ù„Ø¹Ù„Ø§Ù‚ØªÙ‡Ù…. Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† Ø¨Ù†Ù‘Ø§Ø¡ ÙˆØ¥ÙŠØ¬Ø§Ø¨ÙŠ ÙˆÙŠÙ‡Ø¯Ù Ù„Ù…Ø³Ø§Ø¹Ø¯ØªÙ‡Ù… ÙŠÙÙ‡Ù…ÙˆØ§ Ø¨Ø¹Ø¶ Ø£ÙƒØªØ±. Ù‚Ø³Ù… Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ù„Ù„Ø¢ØªÙŠ:\n1. **Ù†Ù‚Ø§Ø· Ø§Ù„Ù‚ÙˆØ© ÙÙŠ Ø¹Ù„Ø§Ù‚ØªÙƒÙ…:** (3 Ù†Ù‚Ø§Ø· Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„) Ø­Ø§Ø¬Ø§Øª Ø¬Ù…ÙŠÙ„Ø© ÙˆÙˆØ§Ø¶Ø­Ø© ÙÙŠ Ø·Ø±ÙŠÙ‚Ø© ØªØ¹Ø§Ù…Ù„ÙƒÙ… Ù…Ø¹ Ø§Ù„Ù…ÙˆØ§Ù‚Ù Ø²ÙŠ Ø§Ù„ØªÙØ§Ù‡Ù…ØŒ Ø§Ù„ØªÙƒØ§Ù…Ù„ØŒ Ø£Ùˆ Ø§Ù„Ø¯Ø¹Ù….\n2. **Ù†Ù‚Ø§Ø· Ù…Ù…ÙƒÙ† ØªØ´ØªØºÙ„ÙˆØ§ Ø¹Ù„ÙŠÙ‡Ø§:** (Ù†Ù‚Ø·ØªÙŠÙ† Ø£Ùˆ Ø«Ù„Ø§Ø«Ø©) Ø§Ø®ØªÙ„Ø§ÙØ§Øª Ø¨Ø³ÙŠØ·Ø© ÙÙŠ Ø±Ø¯ÙˆØ¯ Ø§Ù„Ø£ÙØ¹Ø§Ù„ Ù…Ù…ÙƒÙ† ØªÙƒÙˆÙ† ÙØ±ØµØ© Ù„Ù„ØªØ·ÙˆØ±ØŒ ÙˆÙ‚Ø¯Ù… Ù†ØµÙŠØ­Ø© Ø¨Ø³ÙŠØ·Ø© ÙˆØ¹Ù…Ù„ÙŠØ© Ù„ÙƒÙ„ Ù†Ù‚Ø·Ø© Ø¹Ø´Ø§Ù† ØªÙ‚ÙˆÙˆØ§ Ø¹Ù„Ø§Ù‚ØªÙ‡Ù… Ø£ÙƒØªØ±.\n3. **Ù…Ù„Ø®Øµ Ø¹Ù„Ø§Ù‚ØªÙƒÙ…:** ÙÙ‚Ø±Ø© Ø£Ø®ÙŠØ±Ø© Ø¨ØªÙ„Ø®Øµ Ø·Ø¨ÙŠØ¹Ø© Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ù„ÙŠ Ø¨ÙŠÙ†ÙƒÙ… Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø·Ø±ÙŠÙ‚Ø© ØªØµØ±ÙÙƒÙ… ÙÙŠ Ø§Ù„Ù…ÙˆØ§Ù‚Ù Ø¯ÙŠ Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø¯Ø§ÙÙŠØ© ÙˆÙ…ÙØ·Ù…Ø¦Ù†Ø©.\n\nØ®Ù„ÙŠ ÙƒÙ„Ø§Ù…Ùƒ ÙˆØ¯ÙˆØ¯ ÙˆÙˆØ§Ø¶Ø­ ÙƒØ£Ù†Ùƒ Ø¨ØªØªÙƒÙ„Ù… Ù…Ø¹Ø§Ù‡Ù… Ù…Ø¨Ø§Ø´Ø±Ø©.`;

                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                
                try {
                    const apiKey = ""; // Left empty
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });

                    let analysisText = "Ø­ØµÙ„Øª Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„ØŒ Ù…Ù…ÙƒÙ† ØªØ¬Ø±Ø¨ÙˆØ§ ØªØ§Ù†ÙŠ.";
                    if (response.ok) {
                        const result = await response.json();
                        if (result.candidates && result.candidates[0]?.content?.parts[0]?.text) {
                            analysisText = result.candidates[0].content.parts[0].text;
                        }
                    }
                    gameState.relationshipAnalysis = analysisText;
                    resultsContainer.innerHTML = analysisText.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong class="text-pink-400">$1</strong>');

                } catch (error) {
                    console.error("Error fetching analysis:", error);
                    resultsContainer.textContent = "ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±. Ø§ØªØ£ÙƒØ¯ÙˆØ§ Ù…Ù† Ø§Ù„Ù†Øª ÙˆØ¬Ø±Ø¨ÙˆØ§ ØªØ§Ù†ÙŠ.";
                } finally {
                    loadingOverlay.classList.add('hidden');
                    setupAiFeatures();
                    showView('results');
                }
            }
            
            function setupAiFeatures() {
                const player1Name = gameState.players[0].name;
                const player2Name = gameState.players[1].name;
                complimentP2Btn.textContent = `Ù‚ÙˆÙ„ Ù„Ù€ ${player2Name} ÙƒÙ„Ù…Ø© Ø­Ù„ÙˆØ©`;
                complimentP1Btn.textContent = `Ù‚ÙˆÙ„ÙŠ Ù„Ù€ ${player1Name} ÙƒÙ„Ù…Ø© Ø­Ù„ÙˆØ©`;
            }

            async function generateDateIdea() {
                loadingText.textContent = "Ø¨ÙÙƒØ± ÙÙŠ Ø®Ø±ÙˆØ¬Ø© ØªÙ„ÙŠÙ‚ Ø¨ÙŠÙƒÙˆØ§...";
                loadingOverlay.classList.remove('hidden');

                const prompt = `Ø£Ù†Øª Ø®Ø¨ÙŠØ± ÙÙŠ ØªØ®Ø·ÙŠØ· Ø§Ù„Ø®Ø±ÙˆØ¬Ø§Øª Ø§Ù„Ø±ÙˆÙ…Ø§Ù†Ø³ÙŠØ© ÙˆØ¨ØªØªÙƒÙ„Ù… Ø¨Ø§Ù„Ø¹Ø§Ù…ÙŠØ© Ø§Ù„Ù…ØµØ±ÙŠØ©. Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¹Ù„Ø§Ù‚Ø© Ø¯Ù‡ Ø¨ÙŠÙ† Ø§ØªÙ†ÙŠÙ†ØŒ Ø§Ù‚ØªØ±Ø­ ÙÙƒØ±Ø© Ø®Ø±ÙˆØ¬Ø© Ù…Ø¨ØªÙƒØ±Ø© ÙˆÙ…Ø®ØµÙˆØµØ© Ù„ÙŠÙ‡Ù… Ù‡Ù…Ø§ Ø§Ù„Ø§ØªÙ†ÙŠÙ†. Ø®Ù„ÙŠ Ø§Ù„ÙÙƒØ±Ø© Ø¯Ù…Ù‡Ø§ Ø®ÙÙŠÙ ÙˆÙ…Ù†Ø§Ø³Ø¨Ø© Ù„Ø´Ø®ØµÙŠØ§ØªÙ‡Ù…. Ø§Ø´Ø±Ø­ Ù„ÙŠÙ‡ Ø§Ù„ÙÙƒØ±Ø© Ø¯ÙŠ Ù…Ù†Ø§Ø³Ø¨Ø© Ù„ÙŠÙ‡Ù….\n\nØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¹Ù„Ø§Ù‚Ø©:\n${gameState.relationshipAnalysis}`;
                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };

                try {
                    const apiKey = ""; // Left empty
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    let suggestionText = "Ù…Ø¹Ø±ÙØªØ´ Ø£ÙÙƒØ± ÙÙŠ Ø­Ø§Ø¬Ø© Ø¯Ù„ÙˆÙ‚ØªÙŠØŒ Ø¬Ø±Ø¨ ØªØ§Ù†ÙŠ.";
                    if (response.ok) {
                        const result = await response.json();
                        if (result.candidates && result.candidates[0]?.content?.parts[0]?.text) {
                            suggestionText = result.candidates[0].content.parts[0].text.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                        }
                    }
                    aiModalTitle.textContent = "ğŸ’¡ ÙÙƒØ±Ø© Ø®Ø±ÙˆØ¬Ø©";
                    aiModalContent.innerHTML = suggestionText;
                } catch (error) {
                    aiModalContent.textContent = "ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±.";
                } finally {
                    loadingOverlay.classList.add('hidden');
                    aiSuggestionModal.classList.remove('hidden');
                }
            }

            async function generateCompliment(complimenter, receiver) {
                loadingText.textContent = `Ø¨Ø¬Ù‡Ø² Ø£Ø­Ù„Ù‰ ÙƒÙ„Ø§Ù… Ù„Ù€ ${receiver.name}...`;
                loadingOverlay.classList.remove('hidden');
                
                const receiverAnswers = receiver.answers.map(item => `Ø§Ù„Ù…ÙˆÙ‚Ù: ${item.question}\nØ±Ø¯ ÙØ¹Ù„Ù‡Ø§: ${item.answer}`).join('\n\n');
                const prompt = `Ø£Ù†Øª "${complimenter.name}" ÙˆØ¹Ø§ÙŠØ² ØªÙ‚ÙˆÙ„ ÙƒÙ„Ù…Ø© Ø­Ù„ÙˆØ© Ù„Ù€ "${receiver.name}". Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø±Ø¯ÙˆØ¯ Ø£ÙØ¹Ø§Ù„Ù‡Ø§ ÙÙŠ Ø§Ù„Ù…ÙˆØ§Ù‚Ù Ø¯ÙŠØŒ Ø§ÙƒØªØ¨ Ù…Ø¬Ø§Ù…Ù„Ø© Ù‚ØµÙŠØ±Ø© ÙˆØµØ§Ø¯Ù‚Ø© Ù…Ù† Ø§Ù„Ù‚Ù„Ø¨ Ù„ÙŠÙ‡Ø§ Ø¨Ø§Ù„Ø¹Ø§Ù…ÙŠØ© Ø§Ù„Ù…ØµØ±ÙŠØ©. Ø®Ù„ÙŠ Ø§Ù„ÙƒÙ„Ø§Ù… ÙŠØ¹Ø¨Ø± Ø¹Ù† Ø­Ø§Ø¬Ø© Ù…Ù…ÙŠØ²Ø© ÙÙŠ Ø´Ø®ØµÙŠØªÙ‡Ø§ Ø¹Ø¬Ø¨ØªÙƒ Ù…Ù† Ø·Ø±ÙŠÙ‚Ø© ØªØµØ±ÙÙ‡Ø§.\n\nØ¥Ø¬Ø§Ø¨Ø§Øª ${receiver.name}:\n${receiverAnswers}`;
                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };

                try {
                    const apiKey = ""; // Left empty
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    let complimentText = "Ø§Ù„ÙƒÙ„Ø§Ù… Ø§Ù„Ø­Ù„Ùˆ Ù…Ø´ Ø¹Ø§ÙŠØ² ÙŠØ·Ù„Ø¹ Ø¯Ù„ÙˆÙ‚ØªÙŠØŒ Ø¬Ø±Ø¨ ØªØ§Ù†ÙŠ.";
                    if (response.ok) {
                        const result = await response.json();
                        if (result.candidates && result.candidates[0]?.content?.parts[0]?.text) {
                            complimentText = `"${result.candidates[0].content.parts[0].text.replace(/\n/g, '<br>')}"`;
                        }
                    }
                    aiModalTitle.textContent = `ğŸ’Œ Ø±Ø³Ø§Ù„Ø© Ù…Ù† ${complimenter.name}`;
                    aiModalContent.innerHTML = complimentText;
                } catch (error) {
                    aiModalContent.textContent = "ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±.";
                } finally {
                    loadingOverlay.classList.add('hidden');
                    aiSuggestionModal.classList.remove('hidden');
                }
            }

            // --- Event Listeners ---
            player1NameInput.addEventListener('input', validateSetup);
            player2NameInput.addEventListener('input', validateSetup);
            startGameBtn.addEventListener('click', startGame);
            playAgainBtn.addEventListener('click', init);
            suggestDateBtn.addEventListener('click', generateDateIdea);
            complimentP2Btn.addEventListener('click', () => generateCompliment(gameState.players[0], gameState.players[1]));
            complimentP1Btn.addEventListener('click', () => generateCompliment(gameState.players[1], gameState.players[0]));
            closeAiModalBtn.addEventListener('click', () => aiSuggestionModal.classList.add('hidden'));

            // --- Initial Load ---
            init();
        });
    </script>

</body>
</html>
